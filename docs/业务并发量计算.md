### 业务并发量计算



大部分请求的响应时间在 15 - 30 毫秒左右，这里的响应时间是指服务器处理这个请求所花费的时间，从客户端测量到的时间可能会稍长一些。想象如果服务器上只有一个 CPU 核心在逐个地在处理请求，如果每个请求花费 15 毫秒的话，那么每秒可以处理 66 个请求，也就是我们前面提到的 66 QPS；而如果都是复杂的请求，每个需要 30 毫秒的话，那么服务器就只有 33 QPS 了。可以看到在处理能力不变的情况下（只有一个核心），响应时间越高，QPS 就越低。又如果在响应时间不变的情况下，如果我们增加一个 CPU，QPS 就会翻倍，及三者的关系如下：

吞吐量（QPS）= 处理能力（CPU）/ 响应时间

其实 CPU 的数量就是并发最基本的概念，即有多少个 CPU 在工作。当然在实际的服务器端环境中，我们在 CPU 的基础上建立起了进程、线程、协程这样复杂的抽象、通过异步的 IO 提高 CPU 的利用率 —— 当需要从硬盘或网络读取数据时，CPU 会去做其他工作，所以并发和 CPU 的比值会比 1 高一些，IO 越多，这个比值会越高。

这时我们可以观测到的并发数就是服务器在同时处理多少个请求，也即「并发连接数」。

对于 Web 后端的场景来说（而不考虑推送等长链接的场景），我们希望尽快地给客户端响应，所以请求在服务器端花费的几十毫秒中每一毫秒都是必不可少的：可能是在进行计算、也可能是在向磁盘或网络读写数据，都在占用着服务器的资源，因此并发依然是衡量服务器负荷和处理能力的关键指标。

除了并发本身，我们还经常提到「最大并发」的概念，最大并发就是在单位时间（通常是一天）里并发最高的那一刻有多少个 CPU 在为你工作。大部分应用的请求量并不是均匀地分布在一天中的，因为用户们往往会集中在傍晚的几个小时中使用手机，这些时段中的请求量要远远高于凌晨。所以人人都希望在傍晚得到更多的计算能力，但遗憾的是这些计算能力需要原子世界中的 CPU 去支持，你不可能在傍晚购买一批服务器然后在凌晨卖掉（当然，这其实是云计算要解决的问题），所以为了支撑傍晚的高并发，我们必须去准备那么多的服务器、必须在凌晨让很多服务器闲置，因此其实我们只关心一天中最高的并发数 —— 这代表了我们需要采购多少硬件资源。

当然，LeanCloud 的存在就是为了帮助开发者减轻维护后端的负担，应用开发者往往更关注的是「我有 100 万用户对应多少并发」。但这个问题往往得不到一个答案，因为有太多的因素在影响着最后的结果，例如你的 100 万用户中可能并不是每个人每天都会打开你的应用（每日活跃用户比例）；而且用户对于不同类型的应用使用的频率也并不相同（平均打开次数）；不同类型的应用在工作期间发起的请求数量也不相同（平均请求数量）；对于不同类型的请求，需要占用服务器的计算能力同样不同（平均响应时间）；最后还要考虑到你的大部分用户会集中在傍晚的几个小时使用你的应用，对于游戏抽奖、电商秒杀之类的场景，用户会更加集中在几分钟内使用你的应用。前些天我根据这些指标编写了一个简单的计算器（ [https://budget.leanapp.cn](https://link.zhihu.com/?target=https%3A//budget.leanapp.cn/) ），将最大并发数的计算抽象为了前面提到的几个指标，如果你能给每个指标一个相对准确的估算，那么就可以计算出一个可供参考的并发数。





little 定律么， N= X*R





一台数据库服务器能够承受多大的并发量受内外两方面因素影响。

内在因素

搞清楚需要估算的数据库服务器是什么配置：

1. 确定数据库是MySQL还是Oracle亦或是DB2、PostgreSQL等；

2. CPU是几核？现代数据库应用都充分的运用了多核CPU的并行处理能力；

3. 内存多大？数据库的索引数据、缓存数据都会进入内存中；

4. 磁盘IO能力：数据库文件都存储在磁盘中，所以磁盘的IO能力将是影响数据库性能的最直接因素；

5. 网络带宽：网络的上行和下行带宽，数据库服务器可支持的最大连接数是多少



外在因素

无论是应用程序开发还是SQL查询、操作都遵循“天下武功，唯快不破”的道理。更快意味着服务器资源的快速释放，以便CPU能继续处理其他的任务请求。

做评估数据库的并发量的时候，需要结合使用数据库的程序，否则数据库服务器性能再好，也是属于纸上谈兵。

做数据库并发量评估最好的办法是做数据库压力测试，压力测试的时候，我们可以一点一点的加压力，逐步的得出数据库的：

• QPS：Queries Per Second 每秒处理的查询数（如果是数据库，就相当于读取）

• TPS：Transactions Per Second 每秒处理的事务数(如果是数据库，就相当于写入、修改)

• IOPS：每秒磁盘进行的I/O操作次数

![img](https://pic3.zhimg.com/80/v2-a80b69dd2d8c77eebf8282721ec61d86_720w.jpg)

得出这些数据，便能做到心中有数，也能准确的判断出能否支撑住接入的程序和业务。

常用的压测工具：

• sysbench

• Tpcc-mysql

• mysqlslap

如何使用的问题大家可以自行搜索一下，也可以使用这些工具实验一下。

没有固定的公式去计算服务器的并发量，即使相同配置下的不同服务器，也无法做到相同水平的处理能力，必须结合服务器自身的情况和业务的具体情况做大致的预估，并最终进行全场景业务压力测试来确定具体并发数值。

服务器遇到高并发问题时，由于资源和同时处理请求的能力有限，服务端的处理和响应速度就会大幅降低，严重的会使服务器崩溃。



可以通过以下方法，避免服务器的并发量超出服务器的承受范围：

**一、应用优化**

可以在网页上进行流量优化，使用压缩传输的功能，减少了流量的产生也提高了速度，同时动态页面静态化，可以减少不必要的图片和视频等需要占据和消耗大量空间的内容。

**二、数据库优化**

选择一个合理的数据库引擎，对其进行配置优化，能起到一个决定性的作用。使用存储过程来处理携带复杂数据逻辑的请求，同时对数据库的表进行降低数据量的处理，可以有效降低流量并发。

**三、配置优化**

增加资源、优化配置是是最简单粗暴的方法，可以增大带宽或对某些配置进行升级，或直接购买更高配置。如果请求量还是过大，可以提供多个服务器来实现任务分摊。

**四、减少请求数量**

避免重复的请求消耗不必要的资源；通过客户端自身的处理能力来响应请求，而不必到达服务端，这两方面可以有效避免由于请求量过于庞大而造成的超出服务器承受范围的问题。



![img](https://pic1.zhimg.com/80/v2-132b090d29f0556a12c6ff6c34e2dbf0_720w.jpg)





这篇文章解决了很多用户的难题，就是如何通过最大用户并发数来确定系统最大用户数，因为这个问题不解决的话，用户很难挑选到最为适合自身系统的服务器，我们来看看这篇文章。以下是作者原文。 本篇主要是性能方面的。 一个系统的最大并发用户数为1100，怎么能推算出该系统的支持最大用户数。 其中用户性能要求如下：支持100万注册用户 性能需求分析： 

1、根据用户的要求，本系统要支持100万用户，其中性能机器配置如何？高峰值是多少？带宽？等 

2、如果都是采用公司的测试环境，那么本次性能应该做哪几种性能？性能评测、负载测试、强度测试？

3、怎么算出并发用户数？响应时间？ 性能指标确定： 因为用户的性能需求太广，没有定到具体的数值。



那么我怎么开展后继的工作？

1、确定采用公司测试环境，不用考虑环境问题。也就是说，客户端、服务端以及带宽等一系统都可以不用考虑，这是固定。 

2、考虑此项目组以前开发过的系统性能情况，能否做为一个参考值。解决方案：找出本项目组以并发过二个项目，其性能个项指标进行求权。其中浏览功能：并发数为1100，平均响应时间363秒；每用户平均响应时间为0.33秒。每秒中并发3个用户。其中一系统用户已达500万，另一系统用户为320万。并且二系统一直运行正常，但目前的二系统的服务器各为3台。可以得出一台服务器为载166万，甚至更多。（因为服务器中有求权的关系） 

3、100万用户，那么怎么计算出他的每小时峰值活动用户数？ 解决方案：采用80•20原则计算得到每小时峰值活动用户数 6.667万/小时；那么每秒中的同一功能点点击并发数应该是18.5。

4、怎么得其并发数？ 解决方案：本系统有多少个功能点？功能点为153个；也就是本系统在高峰值时一功能将被点击1258次，每秒点击0.35次。（不考虑间隔时间）考虑以前本项目组的数值。初步设置并发数为1100，主要以浏览功能为主、其次是查询和新增。 

5、应该测试那种性能类型经再三考虑，三种性能都进行测试。 执行性能： 评测，依据性能指标确定中的第三点，将用户的并发设置为300-350，看其情况。负载测试，以1100为起点强度测试，为15小时和24小时为准 性能测试结果： 发现本系统最大用户支持为1100.失败用户最高为209，响应时间为315。可以判断此系统最大并发数为1100左右。也就说此系统在一台服务器上可支持150万用户数。 根据上述情况，可以得出： 1100用户并发时，用户一共响应时间为315秒（即每用户平均响应时间0.005秒），其中最高产生209个失败用户，但成功用户基本上可以完成后续操作，符合现系统要求的最大稳定用户数。由此可得出本系统在新增功能点中支持最大用户并发数为1100。按照1*100比例，计算得到每小时峰值活动用户数11万/小时；采用80•20原则计算得出本系统支持注册用户数约为165万。而本系统性能需求大规模支持100万注册用户，由上述的数据我们的系统已达到本系统性能需求。 注：100万，采用80•20原则计算得到每小时峰值活动用户数6.667万/小时。









并发的意思是指网站在同一时间访问的人数，人数越大，瞬间带宽要求更高。服务器并发量分为：1.业务并发用户数；2.最大并发访问数；3.系统用户数；4.同时在线用户数；

假设一个OA系统有1000用户，这是系统用户数；最高峰同时有500人在线，是“同时在线人数”，也称作“最大业务并发用户数”；500个同时使用系统用户中20%查看系统公告，不构成压力；20%填写表格（只在提交时才会请求，填写对服务器不构成压力）；40%在发呆（什么都没做）；20%用户不停从一个页面跳转另一个页面（只有这20%对服务器产生了压力）。

说明服务器实际压力，能承受的最大并发访问数，既取决于业务并发用户数，还取决于用户的业务场景，这些可以通过对服务器日志的分析得到。

一般只需要分析出典型业务（用户常用，最关注的业务操作）

给出一个估算业务并发用户数的公式（测试人员一般只关心业务并发用户数）

C=nL/T

C^=C+3×(C的平方根)

C是平均的业务并发用户数、n是login session的数量、L是login session的平均长度、T是指考察的时间段长度、C^是指业务并发用户数的峰值。

该公式的得出是假设用户的login session产生符合泊松分布而估算得到。

假设OA系统有1000用户，每天400个用户发访问，每个登录到退出平均时间2小时，在1天时间内用户只在8小时内使用该系统。

C=400×2/8=100

C^=100+3×(100的平方根)=100+3×10=130

另外，如果知道平均每个用户发出的请求数u，则系统吞吐量可以估算为u×C

请注意：精确估算，还要考虑用户业务操作存在一定的时间集中性（比如上班后1小时内是OA系统高峰期），采用公式计算仍然会存在偏差。针对例子OA系统可以把1小时设定为考察时间的粒度，将一天8小时划分为8个区间，这样可以解决业务操作存在集中性问题，更趋于精准，偏差更小